---
title: "HTTP通信からWebの仕組み、Railsがどのように動くかまで体系的にまとめてみる。"
emoji: "👏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ruby", "rails", "http", "web"]
published: false
---
# インターネットの仕組み
どのようにつながっているか..

> ![インターネットの仕組み](https://user-images.githubusercontent.com/77420123/159201734-43f5f228-841a-40d7-8a8f-38445e41cbad.jpeg)
引用 : 「コンピュータ用語学び塾」より

1. 無線ルータからプロバイダのサーバにつながる
2. プロバイダのサーバからインターネットへつながる
3. インターネットからそれぞれのサーバに繋がる
4. それぞれのサーバーからデータを取得してデータが手元に返ってくる。

### どのように通信されているか
> ![OSI参照モデル](https://user-images.githubusercontent.com/77420123/159202205-82484285-d03e-46e7-a7c4-90d99ccd84c9.png)
引用 : 「Hatena Blog けんのへや」より

上記を **『手紙を届ける』** ということにたとえて説明していきます。

1. **どんな手段で運ぶか?**
これが、物理層・データリンク層（ネットワークインターフェイス層）に該当します。
:::message
具体的には、Ethernet・Wi-Fi等
> Ethernetとは、ネットワークやコンピューター間での通信モデル TCP/IPプロトコルのネットワークインターフェース層に対応する有線の規格のことです。以下が画像（多分見たことあるはず...）
![OSI参照モデル](https://user-images.githubusercontent.com/77420123/159202599-cb95327c-7da4-4a22-87c1-ea980a648018.jpeg)
:::

2. **どこに運ぶか?**
これが、ネットワーク層（インターネット層）に該当します。
ここで用いる概念が、IPアドレス（インターネットにおける住所）です。
> ![250px-Ipv4_address_ja svg](https://user-images.githubusercontent.com/77420123/159203160-97ed7eb8-b844-4485-a58e-3acf50f4efae.png)
引用 : 「Wikipedia」より

:::message
もう少し詳しく...
> IPアドレスは、IPネットワーク上の情報機器を識別するために指定するネットワーク層における識別用の番号である。
引用 : 「Wikipedia」より
:::

3. **何号室か?（マンション・アパートみたいなイメージです）**
これが、トランスポート層に該当します。
ここで用いる概念が、ポート番号です。
以下のように役割は番号によって大体決まってます。
> ![port](https://user-images.githubusercontent.com/77420123/159203589-25b3a601-965a-400b-b8be-fb0c11119b85.jpeg)
引用 : 「エンジニアの入り口」より

:::message
特によく使用するものとして、80番のHTTPや443番のHTTPSなどがあります。
:::

4. **手紙の内容は?**
書き方は、場面に応じてある程度決まってます。
それがプロトコルです。これはよく通信する上での『お約束』みたいにたとえられることがあります。他にも、『手順』とか『規約』とか。
> ![port2](https://user-images.githubusercontent.com/77420123/159204171-db46d51b-7b77-4963-8273-20080950bdf3.jpeg)
引用 : 「エンジニアの入り口」より

5. **ここでようやく手紙が読まれる。**
:::message
上記の1から5までのポイント
- CSI参照モデルは、パケットの中身の構造を示している。
- ネットワークのやりとりをするときにそれぞれの階層で決め事を決めておくことでやりとりができる。
:::

# Webの仕組み
### DNS（Domain Name System）
`https://....`みたいなよく目にするのがドメインです。
> DNS（ドメイン）とは、インターネットなどのIPネットワーク上でドメイン名（ホスト名）とIPアドレスの対応関係を管理するシステム
引用 : IT用語辞典

### どのようにドメインからIPアドレスが分かるか?
> ![zu01_02](https://user-images.githubusercontent.com/77420123/159205367-4a305ed1-3f86-463a-bdab-6094d8b5413b.jpeg)
引用 : 日経XTECH

1. 『`https://www.aaa.jp`のIPアドレスを教えて』とDNSサーバーに問い合わせする。
2. DNSサーバが色々なDNSサーバを経由して、IPアドレス（`192.168.0.1`）を教えてくれる。
3. IPアドレスでWebサーバにアクセスする。（ブラウザの裏で実行されている）

:::message
ここで宛先がわかったのでようやく、クライアントとWebサーバで通信できます。
:::

### HTTPの仕組み
> ![zu3-1](https://user-images.githubusercontent.com/77420123/159205883-ee394ef7-e9a3-42e4-b76a-9d570965a7a4.jpeg)
引用 : 日経XTECH

:::message
HTTP（HyperTextTransferProtocol）とは、HyperTextを転送する仕組みです。
:::

手順
1. HTTPリクエストを送る
:::message
HTTPリクエストはまず、リクエストメソッドでメソッドの定義をします。かつリクエストの中身は、HTTPリクエストヘッダとHTTPリクエストボディに分かれます。詳しくは場合により異なるので注釈を確認ください。
:::

:::message alert
リクエストメソッドの内容によっては、HTTPリクエストボディとHTTPレスポンスボディのどちらか片方があったり、なかったりします。
以下の図を参考にしてください。
| リクエストメソッド | 説明 | リクエストボディ | レスポンスボディ |
| ---- | ---- | ---- | ---- |
| GET | データ取得 | × | ○ |
| POST | データ送信 | ○ | ○ |
| PUT | データ更新 | ○ | × |
| PATCH | データの一部更新 | ○ | ○ |
| DELETE | データ削除 | △ | △ |
| HEAD | ヘッダのみリクエスト | × | × |
> PUTとPATCHの違い
PUTは、データをすべて更新します。
PATCHは、データの一部を更新します。
※RailsのUpdateメソッドは、PATCHで動いています。
:::


2. HTTPレスポンスをもらう
:::message
HTTPレスポンスは、ステータスコード（状態を表すもの）とともにHTTPレスポンスを返し、中身は、HTTPレスポンスヘッダとHTTPレスポンスボディに分かれます。

HTTPレスポンスステータスコード
| ステータスコード | カテゴリ | 表記 | 説明 |
| ---- | ---- | ---- | ---- |
| 200 | 成功レスポンス | OK | リクエスト成功 |
| 204 | 成功レスポンス | No Content | レスポンスのコンテンツはないが、リクエストは成功 |
| 301 | リダイレクション | Moved Permanently | URLが永遠に変更されたので移動してね |
| 302 | リダイレクション | Found | URLが一時的に変更されたので移動してね |
| 403 | クライアントエラー | Forbidden | アクセス権がない |
| 404 | クライアントエラー | Not Found | リソースがない |
| 500 | サーバエラー | Internal Server Error | サーバ側で処理出来ないエラー |
| 502 | サーバエラー | Bad Gateway | サーバの通信状態にエラーがある |
| 503 | サーバエラー | Service Unavailable | サーバが処理できない |
| 504 | サーバエラー | Gateway Timeout | レスポンスのタイムアウト |
:::
3. クライアントに戻ってくる（手元のPCとか）

:::message
ローカルの開発でも、ローカルのWebサーバに対してHTTPリクエストを送って、HTTPレスポンスをもらって、ローカルのクライアント（ブラウザ）に戻ってくるという仕組みになっている。
※インターネットを返さなくても同じ仕組みになっている。
:::

# Railsがどのように通信しているか?
では、ここまででインターネットの仕組みとWebの仕組みをざっくりとわかった上でRailsがどのように動いていくのか見ていこうと思います。
> ![4042f554557abe95724fcdcd9dae51b5](https://user-images.githubusercontent.com/77420123/159213543-e90f7f35-aee5-482f-86c6-b6c769feabd0.png)
引用 : RailsTutorial

上記の画像をもとに説明していこうと思います。

### 前提

:::message
前提として、①と⑧に関してはそれぞれWebの仕組みのHTTPのところで説明したHTTPリクエスト（①）とHTTPレスポンス（⑧）にあたります。
なので、先程のHTTPの手順の1と2の間の役割をRailsアプリケーションが担ってくれてるイメージです。
1. HTTPリクエストを送る
2. HTTPレスポンスをもらう
3. クライアントに戻ってくる（手元のPCなど）
:::

### それでは、Railsの手順について
1. クライアント側から何らかのHTTPリクエストがとんでくる。
（ここでは、`/users`パスにデータが送信されているので、GETリクエストが送信されます。）

**-----ここからRails------**

2. リクエストが送られると、`routes.rb`で割り当てられている`URL/コントローラ`に基づいて、リクエストに対応するアクションを実行します。
（ここでは、`usersコントローラ`の`indexアクション`を呼び出すような記述になっています。）

```ruby
Rails.application.routes.draw do
  # 通常resourcesを用いるパターンが多いですが今回はわかりやすくするためにあえてルーティングを1つだけ記述します。
  get '/users', to: 'users#index'
end
 ```
:::message
詳しくは以下のようになってます。
| HTTP | verb | パス | コントローラ#アクション | 目的 |
| ---- | ---- | ---- | ---- | ---- |
| GET | /users | users#index | すべてのユーザー一覧を表示 |
| GET | /users/new | users#new | ユーザーを1人作成するためのHTMLフォームを返す |
| POST | /users | users#create | ユーザーを1人作成する |
| GET | /users/:id | users#show | 特定のユーザーを表示する |
| GET | /users/:id/edit | users#edit | ユーザー編集用のHTMLフォームを1つ返す |
| PATCH/PUT | /users/:id | users#update | 特定のユーザーを更新する |
| DELETE | /users/:id | users#destroy | 特定のユーザーを削除する|
:::

3. （③~⑤まで）コントローラでは、indexメソッドで`User.all`を呼び出して、`User`モデル経由でデータベースからユーザーのすべてのデータを読み込みます。また、これらのデータは、`@users`というインスタンス変数に代入されます。
```ruby
class UsersController < ApplicationController
  def index
    @users = User.all
  end
end
```
:::message
画像の③~⑤までの処理を分割して説明するとわかりづらいので、ここではまとめて説明しています。
:::

4. ビューでは、先程すべてのデータを代入した`@users`というインスタンス変数を使用して、HTMLを作成します。
```ruby
<h1>ユーザー一覧</h1>
<div>
  <% @users.each do |user| %>
    <p><%= user.name %></p>
  <% end %>
</div>
```

5. ビューテンプレートのレンダリング結果をHTTPレスポンスで送る
**-----ここまでRails------**

6. HTTPレスポンスがクライアント側（手元のPCなど）に戻ってきて、画面が描画される。

以上が **HTTP通信からWebの仕組み、Railsがどのように動くかまで体系的にまとめてみる** でした。
至らない点が多いかもしれません。
その際は、コメントやTwitterなどでご指摘いただけると嬉しいです。
